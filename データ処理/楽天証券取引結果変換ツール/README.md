# 楽天証券取引結果変換ツール

楽天証券の取引履歴（TSV/CSV）を、管理用TSV形式に変換するツールです。GUIとCLIの両方で利用できます。数値クリーニング、現物の買付/売付をFIFO突合、リターン率計算、保有日数（取引営業日ベース、両端含む）を行い、未マッチ取引は別TSVに出力します。

## 動作環境
- Python 3.10 以上を推奨
- 主要依存: `pandas`, `numpy`
- 保有日数の精度向上に推奨: `pandas-market-calendars`, `jpholiday`
- 仮想環境例: `/Users/Shared/my-projects/.venv`

## インストール
```bash
# 例: 既存の仮想環境を使用
source /Users/Shared/my-projects/.venv/bin/activate

pip install -r requirements.txt  # 無い場合は pandas / numpy 等を手動インストール
```

## 入力仕様
- 区切り文字: カンマ / タブ自動判定
- 文字コード: `utf-8-sig` → `cp932` → `utf-8`（errors='ignore'）
- 採用条件: `取引区分 == 現物` かつ `信用区分 == '-'` かつ `売買区分 ∈ {買付, 売付}`
- 必須列（主要）: 銘柄コード, 銘柄名, 市場名称, 口座区分, 取引区分, 売買区分, 信用区分, 数量［株］, 単価［円］, 約定日, 受渡金額［円］（無い場合は単価×数量で算出）
- 銘柄コードは4桁0埋めに正規化。  
- 例外: 同一約定日に「信用新規×売建」がある場合、その日の買付は除外。

- マッチ済: `<入力ファイル名>_converted.tsv`（18列固定）  
  `No, 銘柄コード, 銘柄名, 権利月, 市場, 貸借, 保持期間, 購入月, 売却月, 口座区分, 数量, エントリー日, 購入金額合計, イグジット日, 売却金額合計, 損益, リターン率, 保有日数`
  - FIFOで買付/売付を突合し、部分約定は単価×数量を優先（受渡金額があれば比率配分）。売却未実行の買付も売却欄空欄で出力。
  - ソート: エントリー日 → イグジット日 → 銘柄コード → No再採番。
- 未マッチ: `<入力ファイル名>_unmatch.tsv`（13列）  
  理由, 約定日, 銘柄コード, 銘柄名, 市場名称, 口座区分, 取引区分, 売買区分, 信用区分, 数量［株］, 単価［円］, 受渡金額［円］, 備考  
  売り先行や買い残などを記録（信用新規売建と同日の買付は除外）。
- 丸め: 平均単価は小数2桁、リターン率は小数4桁（ともにROUND_HALF_UP）。金額は整数円。保有日数は営業日計算（JPX→jpholiday→平日）。

## 使い方（GUI）
1. `python 楽天証券取引結果変換ツール.py` を実行。
2. 「入力ファイル」に取引履歴 TSV/CSV を指定（手入力または「参照」ボタン）。
3. 出力先フォルダを必要に応じて変更（未指定なら入力と同じ場所）。
4. 「保有日数を出力する」を必要に応じてチェック。
5. 「変換を実行」を押下。完了ダイアログで出力パスを確認。

## 使い方（CLI）
```bash
# 保有日数あり（デフォルト）
python 楽天証券取引結果変換ツール.py ./tradehistory(JP)_20251129.csv

# 出力先を指定
python 楽天証券取引結果変換ツール.py ./tradehistory.csv ./output_dir

# 保有日数なし
python 楽天証券取引結果変換ツール.py ./tradehistory.csv ./output_dir false
```

## 典型的なエラーと対処
- 「入力ファイルを指定してください」: 入力パスが未設定。GUIでパスを入力/参照し直してください。
- 「入力ファイルが存在しません」: パスのタイプミスまたは権限不足。存在を確認してください。
- 文字化け: `cp932` / `utf-8-sig` いずれでも読み込めない場合、元ファイルのエンコーディングを確認してください。

## 既知の制約
- 企業アクション等の特殊取引は未対応（非現物/信用は未マッチに回収）。
- 楽天証券のフォーマット変更時は `SRC` 辞書を更新が必要。
- 保有日数は取引時間帯を考慮しません。祝日ライブラリ未導入時は平日近似。

## ライセンス
社内利用を想定。必要に応じて追記してください。
