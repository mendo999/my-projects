# 楽天証券取引結果変換ツール 実装仕様書

**バージョン:** 1.2
**作成日:** 2025-11-29
**最終更新日:** 2025-11-29

---

## 1. 概要

### 1.1 目的
楽天証券から出力される取引履歴（TSV/CSV形式）を、管理用のTSV形式に変換し、数値データのクリーニング・買付/売付の突合・保有日数の自動計算を行う。未マッチ取引は別TSVに出力する。

### 1.2 主要機能
1. **TSV/CSV入力の自動判定**（区切り文字・文字エンコーディング）
2. **数値データのクリーニング**（カンマ、％記号、括弧などの除去）
3. **買付/売付のFIFO突合と未マッチ抽出**（単価×数量を優先した金額算出）
4. **保有日数の自動計算**（取引営業日ベース、両端含む）
5. **GUI/CUI両対応**

### 1.3 出力形式
- **フォーマット:** TSV（タブ区切り）
- **エンコーディング:** UTF-8 BOM付き（`utf-8-sig`）
- **ファイル名:** `<入力ファイル名>_converted.tsv`（マッチ済）、`<入力ファイル名>_unmatch.tsv`（未マッチ）

---

## 2. アーキテクチャ

### 2.1 全体構成

```
[入力ファイル (TSV/CSV)]
      ↓
[区切り文字・エンコーディング自動判定]
      ↓
[pandas DataFrame 読み込み]
      ↓
[データ変換処理]
  ├─ 入力フィルタ（現物/信用区分-/買付or売付のみ）
  ├─ 数値・日付クリーニング
  ├─ FIFOで買付・売付を突合（単価×数量で金額算出）
  ├─ 未マッチの抽出（売り先行・買い残）
  ├─ リターン率・保有日数計算
  └─ ソートして出力（エントリー日→イグジット日→銘柄コード）
      ↓
[マッチ済TSV / 未マッチTSV出力 (utf-8-sig)]
```

### 2.2 実行モード

| モード | 起動方法 | 用途 |
|--------|----------|------|
| **GUI** | 引数なしで実行 | 対話的な変換作業 |
| **CLI** | `python 楽天証券取引結果変換ツール.py <入力> [出力dir] [保有日数フラグ]` | 自動化・バッチ処理 |

---

## 3. データ仕様

### 3.1 入力ファイル仕様

#### 3.1.1 対応フォーマット
- **区切り文字:** カンマ (`,`) またはタブ (`\t`) を自動判定
- **エンコーディング:** `utf-8-sig` または `cp932` を自動判定

#### 3.1.2 必須列（マッピング定義）

| 論理名 | 入力列候補 |
|--------|-----------|
| 銘柄コード | `銘柄コード` |
| 銘柄名 | `銘柄名` |
| 市場名称 | `市場名称` |
| 口座区分 | `口座区分` |
| 取引区分 | `取引区分` |
| 売買区分 | `売買区分` |
| 信用区分 | `信用区分` |
| 数量 | `数量［株］` |
| 単価 | `単価［円］` |
| 約定日 | `約定日` |
| 受渡金額 | `受渡金額［円］`（無ければ単価×数量で算出） |

#### 3.1.3 データ抽出条件
- `取引区分 == "現物"` かつ `信用区分 == "-"` かつ `売買区分 ∈ {"買付","売付"}`
- 銘柄コードは4桁0埋め数字に正規化（非数字は未マッチ扱い）
- 同一約定日に「取引区分=信用新規」「売買区分=売建」が存在する場合、その日の買付は除外

---

### 3.2 出力ファイル仕様

#### 3.2.1 マッチ済TSV（converted）
- ファイル名: `<入力ファイル名>_converted.tsv`
- 列（18列固定）:  
  `No, 銘柄コード, 銘柄名, 権利月, 市場, 貸借, 保持期間, 購入月, 売却月, 口座区分, 数量, エントリー日, 購入金額合計, イグジット日, 売却金額合計, 損益, リターン率, 保有日数`
- FIFOで買付・売付を突合した行を出力。売却未実行の買付も売却欄空欄で含める。
- ソート順: `エントリー日` → `イグジット日` → `銘柄コード`（安定ソート）後に `No` を1..Nで採番。

#### 3.2.2 未マッチTSV（unmatch）
- ファイル名: `<入力ファイル名>_unmatch.tsv`
- 列（13列）: `理由, 約定日, 銘柄コード, 銘柄名, 市場名称, 口座区分, 取引区分, 売買区分, 信用区分, 数量［株］, 単価［円］, 受渡金額［円］, 備考`
- 含める: 売り先行（買い未登録）、買い残（売却未実行）、非現物・信用取引・必須欠損などのフィルタ除外。買付が信用新規売建と同日のものは出力対象外。

#### 3.2.3 数値フォーマット・計算
- 金額: 整数円（端数は四捨五入）。
- 平均購入価格/平均売却価格: 小数2桁、ROUND_HALF_UP。単価×マッチ数量を優先、受渡金額があれば比率配分も可。
- リターン率: 小数4桁、`(売却金額合計 - 購入金額合計) / 購入金額合計` を ROUND_HALF_UP（購入0はNaN）。
- 保有日数: 営業日ベース（JPX → jpholiday → 平日）、両端含む。

---

## 4. 処理フロー詳細

### 4.1 メイン処理フロー

```
main()
  ├─ [CLI引数チェック]
  │   ├─ 引数あり → convert_file() → 終了
  │   └─ 引数なし → ConverterApp（GUIモード）
  │
  └─ [GUIモード]
      └─ ConverterApp.run_convert()
          └─ convert_file()
```

### 4.2 `convert_file()` 処理詳細

```python
def convert_file(
    input_path: str | Path,
    output_dir: Optional[str | Path] = None,
    output_filename: Optional[str] = None,
    include_holding_days: bool = True
) -> Path
```

#### ステップ1: 入出力パス設定
1. `input_path` をPathオブジェクトに変換
2. `output_dir` が未指定なら入力ファイルと同じディレクトリを使用
3. `output_filename` が未指定なら `<stem>_converted.tsv` を生成

#### ステップ2: 入力ファイル解析
```python
sep, enc = sniff_delimiter_and_encoding(input_path)
```
- **優先エンコーディング:** `utf-8-sig` → `cp932` → `utf-8`（エラー無視）
- **区切り文字判定:** カンマとタブの出現回数を比較し、多い方を採用

#### ステップ3: DataFrame読み込み
```python
df = pd.read_csv(input_path, sep=sep, encoding=enc)
```

#### ステップ4: データ変換
```python
match_df, unmatch_df = convert_dataframe(df, include_holding_days=include_holding_days)
```

#### ステップ5: TSV出力
```python
match_df.to_csv(out_path, sep="\t", index=False, encoding="utf-8-sig", float_format='%.10g')
unmatch_df.to_csv(out_unmatch_path, sep="\t", index=False, encoding="utf-8-sig", float_format='%.10g')
```

---

### 4.3 `convert_dataframe()` 処理詳細

#### ステップ1: 前処理・フィルタ
- 列名トリム、銘柄コード4桁0埋め正規化。
- 数値列（数量・単価・受渡金額）をクリーニング。
- 約定日を `YYYY/MM/DD` に整形。
- 採用条件（現物/信用区分-/買付or売付）で絞り込み。
- 同一約定日に「信用新規×売建」がある場合、その日の買付を除外。

#### ステップ2: ロット生成
- 買付・売付それぞれを FIFO 用リストに分解（数量0は除外）。

#### ステップ3: FIFO突合
- キー: 銘柄コード + 口座区分。
- 部分約定は単価×マッチ数量を優先（受渡金額があれば比率配分も可）。
- マッチできた買い・売りで1行生成。
- 売り先行（買付なし）は未マッチへ。
- 売却未実行の買付は converted に売却欄空欄で出力し、未マッチにも記録。

#### ステップ4: 集計・計算
- 平均購入/売却価格（小数2桁、四捨五入）、購入/売却金額合計（整数）、損益、リターン率（小数4桁）。
- 保有日数: `_count_trading_days()` で営業日カウント（両端含む）。

#### ステップ5: ソート・採番
- `エントリー日` → `イグジット日` → `銘柄コード` でソート後、`No` を1..Nで採番。

---

## 5. GUI仕様

### 5.1 ウィンドウ構成

```
┌─────────────────────────────────────────────────┐
│ 楽天証券取引結果変換ツール                      │
├─────────────────────────────────────────────────┤
│ 入力ファイル（TSV/CSV）                         │
│ [________________________________] [参照...]    │
│                                                 │
│ 出力先フォルダ（未指定なら入力と同じ）          │
│ [________________________________] [変更...]    │
│                                                 │
│ ☑ 保有日数（取引営業日, 両端含む）を出力する    │
│                                                 │
│ [変換を実行]                        [終了]      │
│                                                 │
│ ・指定列を数値化して上書き出力します...         │
│ （使い方ヒント）                                │
└─────────────────────────────────────────────────┘
```

### 5.2 UI要素

| 要素 | 種別 | 機能 |
|------|------|------|
| 入力ファイルパス | Entry + Button | ファイル選択ダイアログ（TSV/CSV） |
| 出力先フォルダパス | Entry + Button | フォルダ選択ダイアログ |
| 保有日数チェックボックス | Checkbutton | デフォルトON |
| 変換を実行ボタン | Button | `run_convert()` 実行 |
| 終了ボタン | Button | アプリケーション終了 |

### 5.3 macOS対応機能

1. **ウィンドウサイズ:** 700x350（リサイズ可能）
2. **ダークモード対応:** システム色を検出してラベルの文字色を調整
3. **グリッドレイアウト:** `columnconfigure()` で列の伸縮を制御

### 5.4 エラーハンドリング

```python
try:
    # 変換処理
    out_path = convert_file(...)
    messagebox.showinfo("完了", f"変換が完了しました。\n\n出力: {out_path}")
except Exception as e:
    messagebox.showerror("エラー", f"変換に失敗しました。\n\n{e}")
```

---

## 6. CLI仕様

### 6.1 コマンドライン引数

```bash
python 楽天証券取引結果変換ツール.py <入力ファイル> [出力ディレクトリ] [保有日数フラグ]
```

| 引数 | 必須/任意 | デフォルト | 説明 |
|------|-----------|------------|------|
| `<入力ファイル>` | 必須 | - | TSV/CSVファイルのパス |
| `[出力ディレクトリ]` | 任意 | 入力と同じ | 出力先フォルダ |
| `[保有日数フラグ]` | 任意 | `True` | `0`, `false`, `off`, `no` で無効化 |

### 6.2 実行例

```bash
# 基本実行（保有日数あり）
python 楽天証券取引結果変換ツール.py ./tradehistory.csv

# 出力先を指定
python 楽天証券取引結果変換ツール.py ./tradehistory.csv ./output

# 保有日数なし
python 楽天証券取引結果変換ツール.py ./tradehistory.csv ./output false
```

### 6.3 出力メッセージ

```
出力: /path/to/tradehistory_converted.tsv
```

---

## 7. エラー処理・例外ハンドリング

### 7.1 ファイル入出力

| エラー | 原因 | 対処 |
|--------|------|------|
| `FileNotFoundError` | 入力ファイルが存在しない | ユーザーにエラーメッセージ表示 |
| `UnicodeDecodeError` | エンコーディング判定失敗 | `utf-8` + `errors="ignore"` でフォールバック |
| `PermissionError` | 出力先への書き込み権限なし | ユーザーにエラーメッセージ表示 |

### 7.2 データ変換

| エラー | 原因 | 対処 |
|--------|------|------|
| 必須列の欠損 | 入力CSVに必須列がない | 空文字列のSeriesで補完 |
| 数値変換失敗 | 非数値データ | `NaN` に変換（`errors="coerce"`） |
| 日付パース失敗 | 不正な日付形式 | `NaN` に変換（保有日数も `NaN`） |
| ゼロ除算 | 購入価格が0 | `np.errstate` で警告抑制、`NaN` に変換 |

### 7.3 外部ライブラリ依存

| ライブラリ | 不在時の動作 | 影響範囲 |
|------------|--------------|----------|
| `pandas_market_calendars` | 次の方法（jpholiday）にフォールバック | 保有日数の精度低下 |
| `jpholiday` | 次の方法（平日のみ）にフォールバック | 祝日がカウントされる |
| （いずれも不在） | `numpy.busday_count` で近似 | 祝日がカウントされる |

---

## 8. 依存関係

### 8.1 必須ライブラリ

```python
pandas>=1.3.0
numpy>=1.20.0
```

### 8.2 オプションライブラリ（推奨）

```python
pandas-market-calendars>=4.0.0  # JPX取引所カレンダー
jpholiday>=0.1.0                # 日本の祝日
```

### 8.3 標準ライブラリ

```python
tkinter          # GUI（Python標準、macOS/Windowsで利用可能）
pathlib          # パス操作
dataclasses      # データクラス
typing           # 型ヒント
```

---

## 9. パフォーマンス・制約事項

### 9.1 処理速度
- **10,000レコード:** 約1-2秒（保有日数計算なし）
- **10,000レコード:** 約3-5秒（保有日数計算あり、JPXカレンダー使用時）

### 9.2 メモリ使用量
- **入力ファイル:** メモリ上に全データを展開（pandas DataFrame）
- **推奨最大サイズ:** 100MB以下（通常の取引履歴なら問題なし）

### 9.3 制約事項
1. **売付のみ抽出:** 買付・配当等のレコードは出力されない
2. **列名依存:** 楽天証券の出力形式変更時は `SRC` 辞書の修正が必要
3. **リターン率:** 手数料・税金を考慮しない単純計算
4. **保有日数:** 取引時間（ザラ場/夜間）は考慮しない

---

## 10. テスト観点

### 10.1 機能テスト
- [ ] TSV入力の正常変換
- [ ] CSV入力の正常変換
- [ ] UTF-8ファイルの読み込み
- [ ] CP932（Shift_JIS）ファイルの読み込み
- [ ] 保有日数計算ON/OFF
- [ ] CLI引数での実行
- [ ] GUI経由での実行

### 10.2 データ検証テスト
- [ ] カンマ付き数値の変換（例: `130,430.00`）
- [ ] 括弧付きマイナス値の変換（例: `(1,234)`）
- [ ] パーセント表記の変換（例: `40.1%`）
- [ ] 欠損値（空文字・NaN）の処理
- [ ] ゼロ除算の安全処理

### 10.3 保有日数テスト
- [ ] 同一営業日の売買 → 1日
- [ ] 週末を跨ぐ売買
- [ ] 祝日を跨ぐ売買
- [ ] JPXカレンダー利用時の精度
- [ ] jpholiday利用時の精度
- [ ] 平日のみカウント時の動作

### 10.4 エラーハンドリングテスト
- [ ] 存在しないファイルパス
- [ ] 書き込み権限のないディレクトリ
- [ ] 不正な日付形式
- [ ] 必須列の欠損
- [ ] 空ファイル
- [ ] 売付レコードが0件のファイル

---

## 11. 将来の拡張案

### 11.1 機能拡張
- [ ] 買付レコードのサポート
- [ ] 配当・株式分割の処理
- [ ] 複数ファイルの一括変換
- [ ] 出力列のカスタマイズ機能
- [ ] 手数料・税金を考慮したリターン率計算

### 11.2 UI/UX改善
- [ ] ドラッグ&ドロップ対応
- [ ] プログレスバー表示
- [ ] 変換履歴の保存
- [ ] 設定ファイルによる列マッピングのカスタマイズ

### 11.3 技術改善
- [ ] ユニットテストの追加
- [ ] ロギング機能の追加
- [ ] 設定ファイル（YAML/JSON）によるカスタマイズ
- [ ] スタンドアロン実行ファイル（PyInstaller）

---

## 12. 変更履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2025-11-29 | 初版作成 |

---

## 13. 参考情報

### 13.1 関連ドキュメント
- [pandas公式ドキュメント](https://pandas.pydata.org/docs/)
- [pandas-market-calendars](https://github.com/rsheftel/pandas_market_calendars)
- [jpholiday](https://github.com/Lalcs/jpholiday)

### 13.2 楽天証券取引履歴フォーマット
- 本仕様書は2025年11月時点の楽天証券の出力形式に基づく
- フォーマット変更時は `SRC` 辞書の更新が必要

---

**文書管理**
作成者: AI Assistant
承認者: （プロジェクトオーナー）
保管場所: `/docs/implementation_spec.md`
