# JPXトレード分析（TSV）README

> 日本株（JPX）を前提に、証券会社の取引履歴（TSV/CSV）を読み込み、TWRやCAGR、PFなど各種KPIをモダンUI（Streamlit+Plotly）で可視化する単一ファイルアプリです。

---

## クイックスタート

```bash
pip install streamlit pandas numpy pandas_market_calendars plotly
streamlit run 取引結果分析.py
```

- 画面左のサイドバーから取引TSV/CSVをアップロード。
- 任意でベンチマーク（TOPIX等）のCSV/TSVもアップロードすると比較ができます。

---

## 画面構成と使い方（概要）

- **サイドバー**：データ読込／期間・銘柄・区分フィルタ／集計モード（重複対応TWR か 連続フル複利）／微小損益の閾値 ε%
- **① 取引結果 全体成績サマリー**：KPI一覧・**TWR**・年率・エクイティ/ドローダウン・年次TWR（あなた単独）
- **年度別サマリー**（カレンダー年）
- **② 貸借/制度 別**、**②-追加）保持日数バケット 別**
- **③ エントリー月 × 保持日数**（区分なし/あり）／**④ エントリー月 別**（区分なし/あり）
- **ベンチマーク比較**：年次TWR／トレーリング（1/3/5年）／アクティブ統計（TE/IR/β/α）
- **原データプレビュー**（生データ/整備済み）

> 推奨：比較や年率の妥当性を見るときは **集計モード＝「重複対応TWR（近似）」** を使ってください。

---

## 対応データ（最低限）

- 取引TSV/CSV：エントリー日・イグジット日・リターン（%でもOK）・数量・損益・銘柄情報 等（列名は自動推定）。
- ベンチマークCSV/TSV（任意）：`date` と `price/nav/close/終値/価格/基準価額` のいずれか。

---

## 用語集（初心者向け）

> **大切な前置き**：以下の「目安」は**一般的な感覚**です。戦略（デイトレ/スイング/長期）、期間、ボラティリティ、レバレッジ、サンプル数で大きく変わります。**目安は参考値**としてください。

### TWR（時間加重リターン）

- **何を見る？**\
  運用そのものの実力。入出金タイミングに左右されず、運用戦略の純粋な成績を示します。
- **どう計算？**\
  日々のリターンを掛け合わせて「期末/期首 − 1」を出す。\
  本ツールの\*\*重複対応TWR（近似）\*\*は、同時保有の複数ポジションを等分配して日次合成します（複数ポジションが同時にあるときの歪みを抑える）。
- **目安（単年）**：\
  +0〜+10%：普通 ／ +10〜+20%：良い ／ +20%超：とても良い（市場環境に依存）

---

### 総合リターン（累積）・年率換算（CAGR）

- **総合**：対象期間全体でどれだけ増えたか（累積）。
- **年率（CAGR）**：総合を年率に直したもの。異なる期間の比較に便利。
- **目安（CAGR）**：0〜5%：普通 ／ 5〜10%：良い ／ 10%超：強い（ボラ低い戦略で高いと優秀）

---

### 勝率（Win Rate）

- **何を見る？**\
  トレードのうち利益で終わった割合（%）。
- **落とし穴**：勝率が高くても**損益比**が低ければ総合では負けることがある。
- **目安**：50〜60%：普通 ／ 60〜70%：良い ／ 70%超：とても良い（戦略依存）

---

### 損益比（Profit / Loss Ratio）

- **何を見る？**\
  平均利益 ÷ 平均損失（絶対値）。1を超えるほど「勝ちが大きい」。
- **期待値の考え方**：\
  期待値 ≈ 勝率 × 平均利益 − (1−勝率) × 平均損失\
  例：勝率40%、損益比2.0なら期待値はプラスになる可能性あり。
- **目安**：0.8〜1.2：普通 ／ 1.2〜2.0：良い ／ 2.0超：とても良い

---

### プロフィットファクター（PF）

- **何を見る？**\
  総利益 ÷ 総損失（絶対値）。1を超えると「総合で勝ち」。
- **注意**：損失が四捨五入などで小さくなり0扱いになると PF が∞ に見えることがある（閾値 ε の設定で回避可能）。
- **目安**：1.0未満：負け ／ 1.0〜1.2：ぎりぎり ／ 1.2〜1.5：普通 ／ 1.5〜2.0：良い ／ 2.0超：とても良い

---

### シャープレシオ（Sharpe Ratio）

- **何を見る？**\
  ボラティリティ1単位あたりの平均収益。高いほど「安定して稼いでいる」。
- **計算（ざっくり）**：平均超過収益 ÷ 標準偏差（年率換算）
- **目安**：<0：悪い ／ 0〜1：物足りない ／ 1〜2：良い ／ 2〜3：とても良い ／ >3：極めて良い

---

### ソルティノレシオ（Sortino Ratio）

- **何を見る？**\
  シャープに似ているが、分母が「下落（悪い日だけ）の偏差」。下振れリスクに対して効率的に稼いでいるかを示す。
- **注意**：負の日がほとんどないと分母が0に近づき、値が非常に大きく（∞）見える場合がある（データ丸めに注意）。
- **目安**：<0：悪い ／ 0〜1：物足りない ／ 1〜2：良い ／ 2超：とても良い

---

### 最大ドローダウン（Max DD）

- **何を見る？**\
  エクイティのピークからの最大下落率。資金曲線がどれだけ落ちたか。
- **目安**：−10%以内：低 ／ −10〜−20%：中 ／ −20%超：高（許容は投資家次第）

---

### ROI（投下資金に対する利益率）

- **何を見る？**\
  総損益 ÷ 総買付金額。キャッシュ効率の概算（時間要因は無視）。
- **解釈**：期間が長いと単純ROIは比較しづらいので、CAGRやTWRと併用する。

---

### XIRR（資金加重年率）

- **何を見る？**\
  実際の入出金タイミングを反映した年率（投資家の体感年率）。入金をマイナス、出金をプラスにして求めるIRR。
- **使い分け**：資金効率を見るときは XIRR、指数比較は TWR を基本にする。

---

### 年次TWR（カレンダー年）

- **何を見る？**\
  その年の累積リターン。年ごとの勝敗がわかる。
- **注意**：サマリーTWR（全期間）とは別物。複数年が良いとサマリーが大きく見えるのは自然。

---

### アクティブ統計（ベンチ比較時）

- **TE（トラッキングエラー）**：ベンチとあなたの**日次乖離の年率**。小さいほどベンチに近い。
- **IR（情報比率）**：平均超過収益 ÷ TE。目安：>0.5：良い ／ >1.0：とても良い
- **β（ベータ）**：ベンチへの感応度。1なら同じ動き、>1ならより振れる。
- **α（アルファ）**：ベンチで説明できない上乗せ年率。

---

## よくある落とし穴（回避策）

- **入力丸めで負リターンが消える → PF=∞ / Sortino=∞**\
  → サイドバーの ε（例：0.05%）を上げて微小を0扱いにする。
- **サマリーTWRが高すぎる（過大評価）**\
  → 「重複対応TWR（近似）」で算出し、同時保有の歪みを是正。
- **年次TWRとサマリーの違い**\
  → 年次はその年の成績、サマリーは全期間の複利累積。整合的な差。

---

## 免責

本ツールは**教育・分析支援**目的です。投資助言ではありません。税務・法務は一般論の範囲に留めています。最終判断はご自身で行ってください。

